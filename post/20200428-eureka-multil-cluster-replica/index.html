<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>如何迁移 Spring Cloud Eureka 注册体系至 k8s - ZengXu&#39;s BLOG</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Zeng Xu" /><meta name="description" content="优雅处理 Eureka 跨集群同步" /><meta name="keywords" content="Spring Cloud, Eureka, k8s, Spring, Java" />






<meta name="generator" content="Hugo 0.60.1 with theme even" />


<link rel="canonical" href="https://www.zeng.dev/post/20200428-eureka-multil-cluster-replica/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">


<link href="/dist/even.3eede659.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="如何迁移 Spring Cloud Eureka 注册体系至 k8s" />
<meta property="og:description" content="优雅处理 Eureka 跨集群同步" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.zeng.dev/post/20200428-eureka-multil-cluster-replica/" />
<meta property="article:published_time" content="2020-04-28T20:32:51+08:00" />
<meta property="article:modified_time" content="2020-05-07T01:00:00+08:00" />
<meta itemprop="name" content="如何迁移 Spring Cloud Eureka 注册体系至 k8s">
<meta itemprop="description" content="优雅处理 Eureka 跨集群同步">
<meta itemprop="datePublished" content="2020-04-28T20:32:51&#43;08:00" />
<meta itemprop="dateModified" content="2020-05-07T01:00:00&#43;08:00" />
<meta itemprop="wordCount" content="3028">



<meta itemprop="keywords" content="Spring Cloud,Eureka,k8s,Spring,Java," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="如何迁移 Spring Cloud Eureka 注册体系至 k8s"/>
<meta name="twitter:description" content="优雅处理 Eureka 跨集群同步"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Zeng Xu&#39;s BLOG</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/about">
        <li class="mobile-menu-item">About</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Zeng Xu&#39;s BLOG</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about">About</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">如何迁移 Spring Cloud Eureka 注册体系至 k8s</h1>

      <div class="post-meta">
        <span class="post-time"> 2020-04-28 20:32 </span>
        
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#heading">背景</a></li>
  </ul>

  <ul>
    <li><a href="#-eureka-">理解 Eureka 集群复制原理</a></li>
    <li><a href="#eureka-cluster-in-k8s">Eureka cluster in k8s</a></li>
    <li><a href="#-eureka-1">为什么关闭 Eureka 自我保护</a></li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="heading">背景</h2>
<p>最近负责着手把公司跑在阿里云 ECS 上的 Spring Cloud 微服务迁移到 k8s，为保证平滑顺畅，仍需 k8s 中保留 Eureka 体系，直到所有服务都跑在 k8s 后，才会着手考虑去 Eureka。根据迁移情况，云主机会处于如下两个阶段:</p>
<ol>
<li>阶段一，部分主机受 k8s 管理，部分不受 k8s 管理。默认情况下，k8s 网络到 ECS 网络为单向畅通，不受管理部分的 ECS 无法通过 ip 直接访问 k8s Pod 网段和Service 网段。</li>
<li>阶段二，所有主机均受 k8s 管理，k8s 网络到 ECS 网络双通。</li>
</ol>
<p>该如何处理 k8s 服务实例与 ECS 服务实例互通互调，有如下方案：</p>
<ol>
<li>迁移到 k8s 的服务实例仍旧注册到 ECS Eureka 集群，对于不受 k8s 管理的实例，采用手工配置 ip table 的方式，保证不受管理部分的 ECS 可以通过 ip 直接访问 k8s Pod 网段和Service 网段；这种方案可以使用到全部迁移完成</li>
<li>在 k8s 中新部署 Eureka 集群，迁移到 k8s 的实例通过切换配置注册到 k8s Eureka 集群；阶段一，将 ECS Eureka 集群单向注册到 k8s Eureka 集群，保证 k8s 实例可以访问 ECS 实例即可(容忍 ECS 实例不能访问 k8s 实例)；阶段二，ECS Eureka 集群与 k8s Eureka 集群双向注册，直到迁移完成。</li>
</ol>
<p>注: 如果迁移开始前即可保证所有 ECS 均可成为 Worker 节点 K8S 管理，则自由选择持续使用外部 Eureka 集群或者一致维持 ECS Eureka 集群与 k8s Eureka 集群双向注册即可。</p>
<p>方案 1 的好处是简单轻松，坏处是需要手工配置 ip table，比较适合 ECS 节点不多的情况。方案 2 的好处是不用手动配置网络，坏处是阶段一区域网络不通。</p>
<p>结合具体情况，我选择了方案 2，对于网络不通的情况，迁移时可先选择较为独立的周边服务，等这部分迁移完，差不多所有节点也能纳入 k8s 管理了。</p>
<img src="/img/2020-04/migrate-simple-schema.jpg" width="700px">
<div class='align-center'>
<p>概要图，省略服务层级和 k8s  Service、Pod 等细节</p>
</div>
<p>下文接着讲述 ECS 集群单向注册 k8s 集群的配置设计以及如何解决遇到问题。</p>
<h1 id="eureka-">Eureka 配置设计</h1>
<p>首先在 /etc/hosts 文件增加如下 DNS 解析规则</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">127.0.0.1 ecs-peer1
127.0.0.1 ecs-peer2
127.0.0.1 k8s-peer1
127.0.0.1 k8s-peer2
</code></pre></td></tr></table>
</div>
</div><p>下面的 yaml 配置展示了如何模拟将 ECS Eureka 集群单向注册到 k8s 集群，有几个配置需要说明</p>
<ul>
<li><em>eureka.server.enable-self-preservation=false</em>，关闭了 k8s Eureka 集群的自我保护功能（原因将在下文说明）</li>
<li><em>eureka.client.fetch-registry=false</em>, 关闭了 ECS Eureka 启动的应用列表获取，如果开启，ECS Eureka 启动时将从 k8s Eureka server 中获取应用列表， k8s 实例会注册到 ECS Eureka，由于网络不通，会导致 ECS 实例访问出错</li>
</ul>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">---<span class="w">
</span><span class="w"></span>server<span class="p">:</span><span class="w">
</span><span class="w">  </span>port<span class="p">:</span><span class="w"> </span><span class="m">8761</span><span class="w">
</span><span class="w"></span>spring<span class="p">:</span><span class="w">
</span><span class="w">  </span>profiles<span class="p">:</span><span class="w"> </span>k8s-peer1<span class="w">
</span><span class="w"></span>eureka<span class="p">:</span><span class="w">
</span><span class="w">  </span>instance<span class="p">:</span><span class="w">
</span><span class="w">    </span>hostname<span class="p">:</span><span class="w"> </span>k8s-peer1<span class="w">
</span><span class="w">    </span>appname<span class="p">:</span><span class="w"> </span>k8s-eureka<span class="w">
</span><span class="w">  </span>client<span class="p">:</span><span class="w">
</span><span class="w">    </span>serviceUrl<span class="p">:</span><span class="w">
</span><span class="w">      </span>k8s-zone<span class="p">:</span><span class="w"> </span>http<span class="p">:</span>//k8s-peer1<span class="p">:</span><span class="m">8761</span>/eureka/<span class="p">,</span>http<span class="p">:</span>//k8s-peer2<span class="p">:</span><span class="m">8762</span>/eureka/<span class="w">
</span><span class="w">    </span>availability-zones<span class="p">:</span><span class="w">
</span><span class="w">      </span>shanghai<span class="p">:</span><span class="w"> </span>k8s-zone<span class="w">
</span><span class="w">    </span>region<span class="p">:</span><span class="w"> </span>shanghai<span class="w">
</span><span class="w">  </span>server<span class="p">:</span><span class="w">
</span><span class="w">    </span>enable-self-preservation<span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span><span class="w"></span>---<span class="w">
</span><span class="w"></span>server<span class="p">:</span><span class="w">
</span><span class="w">  </span>port<span class="p">:</span><span class="w"> </span><span class="m">8762</span><span class="w">
</span><span class="w"></span>spring<span class="p">:</span><span class="w">
</span><span class="w">  </span>profiles<span class="p">:</span><span class="w"> </span>k8s-peer2<span class="w">
</span><span class="w"></span>eureka<span class="p">:</span><span class="w">
</span><span class="w">  </span>instance<span class="p">:</span><span class="w">
</span><span class="w">    </span>hostname<span class="p">:</span><span class="w"> </span>k8s-peer2<span class="w">
</span><span class="w">    </span>appname<span class="p">:</span><span class="w"> </span>k8s-eureka<span class="w">
</span><span class="w">  </span>client<span class="p">:</span><span class="w">
</span><span class="w">    </span>serviceUrl<span class="p">:</span><span class="w">
</span><span class="w">      </span>k8s-zone<span class="p">:</span><span class="w"> </span>http<span class="p">:</span>//k8s-peer1<span class="p">:</span><span class="m">8761</span>/eureka/<span class="p">,</span>http<span class="p">:</span>//k8s-peer2<span class="p">:</span><span class="m">8762</span>/eureka/<span class="w">
</span><span class="w">    </span>availability-zones<span class="p">:</span><span class="w">
</span><span class="w">      </span>shanghai<span class="p">:</span><span class="w"> </span>k8s-zone<span class="w">
</span><span class="w">    </span>region<span class="p">:</span><span class="w"> </span>shanghai<span class="w">
</span><span class="w">  </span>server<span class="p">:</span><span class="w">
</span><span class="w">    </span>enable-self-preservation<span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span><span class="w"></span>---<span class="w">
</span><span class="w"></span>server<span class="p">:</span><span class="w">
</span><span class="w">  </span>port<span class="p">:</span><span class="w"> </span><span class="m">8763</span><span class="w">
</span><span class="w"></span>spring<span class="p">:</span><span class="w">
</span><span class="w">  </span>profiles<span class="p">:</span><span class="w"> </span>ecs-peer1<span class="w">
</span><span class="w"></span>eureka<span class="p">:</span><span class="w">
</span><span class="w">  </span>instance<span class="p">:</span><span class="w">
</span><span class="w">    </span>hostname<span class="p">:</span><span class="w"> </span>ecs-peer1<span class="w">
</span><span class="w">    </span>appname<span class="p">:</span><span class="w"> </span>ecs-eureka<span class="w">
</span><span class="w">  </span>client<span class="p">:</span><span class="w">
</span><span class="w">    </span>fetch-registry<span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span><span class="w">    </span>serviceUrl<span class="p">:</span><span class="w">
</span><span class="w">      </span>ecs-zone<span class="p">:</span><span class="w"> </span>http<span class="p">:</span>//ecs-peer1<span class="p">:</span><span class="m">8763</span>/eureka/<span class="p">,</span>http<span class="p">:</span>//ecs-peer2<span class="p">:</span><span class="m">8764</span>/eureka/<span class="w">
</span><span class="w">      </span>k8s-zone<span class="p">:</span><span class="w"> </span>http<span class="p">:</span>//k8s-peer1<span class="p">:</span><span class="m">8761</span>/eureka/<span class="p">,</span>http<span class="p">:</span>//k8s-peer2<span class="p">:</span><span class="m">8762</span>/eureka/<span class="w">
</span><span class="w">    </span>availability-zones<span class="p">:</span><span class="w">
</span><span class="w">      </span>shanghai<span class="p">:</span><span class="w"> </span>ecs-zone<span class="p">,</span>k8s-zone<span class="w">
</span><span class="w">    </span>region<span class="p">:</span><span class="w"> </span>shanghai<span class="w">
</span><span class="w"></span>---<span class="w">
</span><span class="w"></span>server<span class="p">:</span><span class="w">
</span><span class="w">  </span>port<span class="p">:</span><span class="w"> </span><span class="m">8764</span><span class="w">
</span><span class="w"></span>spring<span class="p">:</span><span class="w">
</span><span class="w">  </span>profiles<span class="p">:</span><span class="w"> </span>ecs-peer2<span class="w">
</span><span class="w"></span>eureka<span class="p">:</span><span class="w">
</span><span class="w">  </span>instance<span class="p">:</span><span class="w">
</span><span class="w">    </span>hostname<span class="p">:</span><span class="w"> </span>ecs-peer2<span class="w">
</span><span class="w">    </span>appname<span class="p">:</span><span class="w"> </span>ecs-eureka<span class="w">
</span><span class="w">  </span>client<span class="p">:</span><span class="w">
</span><span class="w">    </span>fetch-registry<span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span><span class="w">    </span>serviceUrl<span class="p">:</span><span class="w">
</span><span class="w">      </span>ecs-zone<span class="p">:</span><span class="w"> </span>http<span class="p">:</span>//ecs-peer1<span class="p">:</span><span class="m">8763</span>/eureka/<span class="p">,</span>http<span class="p">:</span>//ecs-peer2<span class="p">:</span><span class="m">8764</span>/eureka/<span class="w">
</span><span class="w">      </span>k8s-zone<span class="p">:</span><span class="w"> </span>http<span class="p">:</span>//k8s-peer1<span class="p">:</span><span class="m">8761</span>/eureka/<span class="p">,</span>http<span class="p">:</span>//k8s-peer2<span class="p">:</span><span class="m">8762</span>/eureka/<span class="w">
</span><span class="w">    </span>availability-zones<span class="p">:</span><span class="w">
</span><span class="w">      </span>shanghai<span class="p">:</span><span class="w"> </span>ecs-zone<span class="p">,</span>k8s-zone<span class="w">
</span><span class="w">    </span>region<span class="p">:</span><span class="w"> </span>shanghai<span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>确认你已经在 Eureka server 项目目录，开 4 个控制台依次使用如下命令启动所有 Eureka</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">mvn spring-boot:run -Dspring-boot.run.arguments<span class="o">=</span>--spring.profiles.active<span class="o">=</span>k8s-peer1
mvn spring-boot:run -Dspring-boot.run.arguments<span class="o">=</span>--spring.profiles.active<span class="o">=</span>k8s-peer2
mvn spring-boot:run -Dspring-boot.run.arguments<span class="o">=</span>--spring.profiles.active<span class="o">=</span>ecs-peer1
mvn spring-boot:run -Dspring-boot.run.arguments<span class="o">=</span>--spring.profiles.active<span class="o">=</span>ecs-peer2
</code></pre></td></tr></table>
</div>
</div><p>访问 k8s-peer1:8761 或者 k8s-peer2:8762，可以看到 Eureka 实例 ecs-peer1:8763 和 ecs-peer2:8764 注册到了 k8s-zone
<img src="/img/2020-04/k8s-peer.jpg" width="600px"></p>
<p>访问 ecs-peer1:8763 或者 ecs-peer2:8764，k8s-zone 但 Eureka 并未注册到 ecs-zone
<img src="/img/2020-04/ecs-peer.jpg" width="600px"></p>
<p>再通过 ecs-peer1:8763 注册应用 ecs-to-k8s-app，再通过 k8s-peer1:8761 注册应用 k8s-only-app，发现 ecs-to-k8s-app 注册信息已被同步至 k8s-zone，但 k8s-only-app 注册信息并未被同步至 ecs-zone
<img src="/img/2020-04/k8s-only-app.jpg" width="600px"></p>
<div class='align-center'>
<p>k8s-peer1:8761 注册信息</p>
</div>
<img src="/img/2020-04/ecs2k8s-app.jpg" width="600px">
<div class='align-center'>
<p>ecs-peer1:8763 注册信息</p>
</div>
<p>如进入阶段二，打算切为双向注册，类似地，只需将 k8s Eureka 实例配置改为如下即可</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">port<span class="p">:</span><span class="w"> </span><span class="m">8761</span><span class="w">
</span><span class="w"></span>spring<span class="p">:</span><span class="w">
</span><span class="w">  </span>profiles<span class="p">:</span><span class="w"> </span>k8s-peer1<span class="w">
</span><span class="w"></span>eureka<span class="p">:</span><span class="w">
</span><span class="w">  </span>instance<span class="p">:</span><span class="w">
</span><span class="w">    </span>hostname<span class="p">:</span><span class="w"> </span>k8s-peer1<span class="w">
</span><span class="w">    </span>appname<span class="p">:</span><span class="w"> </span>k8s-eureka<span class="w">
</span><span class="w">  </span>client<span class="p">:</span><span class="w">
</span><span class="w">    </span>serviceUrl<span class="p">:</span><span class="w">
</span><span class="w">      </span>ecs-zone<span class="p">:</span><span class="w"> </span>http<span class="p">:</span>//ecs-peer1<span class="p">:</span><span class="m">8763</span>/eureka/<span class="p">,</span>http<span class="p">:</span>//ecs-peer2<span class="p">:</span><span class="m">8764</span>/eureka/<span class="w">
</span><span class="w">      </span>k8s-zone<span class="p">:</span><span class="w"> </span>http<span class="p">:</span>//k8s-peer1<span class="p">:</span><span class="m">8761</span>/eureka/<span class="p">,</span>http<span class="p">:</span>//k8s-peer2<span class="p">:</span><span class="m">8762</span>/eureka/<span class="w">
</span><span class="w">    </span>availability-zones<span class="p">:</span><span class="w">
</span><span class="w">      </span>shanghai<span class="p">:</span><span class="w"> </span>k8s-zone<span class="p">,</span><span class="w"> </span>ecs-zone<span class="w">
</span><span class="w">    </span>region<span class="p">:</span><span class="w"> </span>shanghai<span class="w">
</span><span class="w">  </span>server<span class="p">:</span><span class="w">
</span><span class="w">    </span>enable-self-preservation<span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h2 id="-eureka-">理解 Eureka 集群复制原理</h2>
<p>Eureka 会选取 eureka.client.availability-zones 声明的所有节点作为同步节点列表（在上面，我通过这种方式实现了单向注册）。</p>
<p>Eureka 集群复制代码在 package com.netflix.eureka.registry, class PeerAwareInstanceRegistryImpl，以实例注册为例</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kt">void</span> <span class="nf">register</span><span class="o">(</span><span class="kd">final</span> <span class="n">InstanceInfo</span> <span class="n">info</span><span class="o">,</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">isReplication</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">leaseDuration</span> <span class="o">=</span> <span class="n">Lease</span><span class="o">.</span><span class="na">DEFAULT_DURATION_IN_SECS</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">info</span><span class="o">.</span><span class="na">getLeaseInfo</span><span class="o">(</span><span class="o">)</span> <span class="o">!</span><span class="o">=</span> <span class="kc">null</span> <span class="o">&amp;</span><span class="o">&amp;</span> <span class="n">info</span><span class="o">.</span><span class="na">getLeaseInfo</span><span class="o">(</span><span class="o">)</span><span class="o">.</span><span class="na">getDurationInSecs</span><span class="o">(</span><span class="o">)</span> <span class="o">&gt;</span> <span class="n">0</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">leaseDuration</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="na">getLeaseInfo</span><span class="o">(</span><span class="o">)</span><span class="o">.</span><span class="na">getDurationInSecs</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="kd">super</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="n">info</span><span class="o">,</span> <span class="n">leaseDuration</span><span class="o">,</span> <span class="n">isReplication</span><span class="o">)</span><span class="o">;</span>
    <span class="n">replicateToPeers</span><span class="o">(</span><span class="n">Action</span><span class="o">.</span><span class="na">Register</span><span class="o">,</span> <span class="n">info</span><span class="o">.</span><span class="na">getAppName</span><span class="o">(</span><span class="o">)</span><span class="o">,</span> <span class="n">info</span><span class="o">.</span><span class="na">getId</span><span class="o">(</span><span class="o">)</span><span class="o">,</span> <span class="n">info</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">isReplication</span><span class="o">)</span><span class="o">;</span>
<span class="o">}</span>

<span class="kd">private</span> <span class="kt">void</span> <span class="nf">replicateToPeers</span><span class="o">(</span><span class="n">Action</span> <span class="n">action</span><span class="o">,</span> <span class="n">String</span> <span class="n">appName</span><span class="o">,</span> <span class="n">String</span> <span class="n">id</span><span class="o">,</span>
                                  <span class="n">InstanceInfo</span> <span class="n">info</span> <span class="cm">/* optional */</span><span class="o">,</span>
                                  <span class="n">InstanceStatus</span> <span class="n">newStatus</span> <span class="cm">/* optional */</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">isReplication</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">Stopwatch</span> <span class="n">tracer</span> <span class="o">=</span> <span class="n">action</span><span class="o">.</span><span class="na">getTimer</span><span class="o">(</span><span class="o">)</span><span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">isReplication</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">numberOfReplicationsLastMin</span><span class="o">.</span><span class="na">increment</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="c1">// If it is a replication already, do not replicate again as this will create a poison replication
</span><span class="c1"></span>        <span class="c1">// 如果是其他节点信息同步，处理结束
</span><span class="c1"></span>        <span class="k">if</span> <span class="o">(</span><span class="n">peerEurekaNodes</span> <span class="o">=</span><span class="o">=</span> <span class="n">Collections</span><span class="o">.</span><span class="na">EMPTY_LIST</span> <span class="o">|</span><span class="o">|</span> <span class="n">isReplication</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="c1">// 如果是应用信息更新，同步注册信息至其他节点
</span><span class="c1"></span>        <span class="k">for</span> <span class="o">(</span><span class="kd">final</span> <span class="n">PeerEurekaNode</span> <span class="n">node</span> <span class="o">:</span> <span class="n">peerEurekaNodes</span><span class="o">.</span><span class="na">getPeerEurekaNodes</span><span class="o">(</span><span class="o">)</span><span class="o">)</span> <span class="o">{</span>
            <span class="c1">// If the url represents this host, do not replicate to yourself.
</span><span class="c1"></span>            <span class="k">if</span> <span class="o">(</span><span class="n">peerEurekaNodes</span><span class="o">.</span><span class="na">isThisMyUrl</span><span class="o">(</span><span class="n">node</span><span class="o">.</span><span class="na">getServiceUrl</span><span class="o">(</span><span class="o">)</span><span class="o">)</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">continue</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="n">replicateInstanceActionsToPeers</span><span class="o">(</span><span class="n">action</span><span class="o">,</span> <span class="n">appName</span><span class="o">,</span> <span class="n">id</span><span class="o">,</span> <span class="n">info</span><span class="o">,</span> <span class="n">newStatus</span><span class="o">,</span> <span class="n">node</span><span class="o">)</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="n">tracer</span><span class="o">.</span><span class="na">stop</span><span class="o">(</span><span class="o">)</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><p>Eureka server 实例通过 register 同时处理应用注册 (isReplication=false) 和 peer 注册同步 (isReplication=true)。如果是应用注册，在本地注册成功后，PeerAwareInstanceRegistryImpl 会将注册信息同步到集群其他节点；如果是其他节点的注册同步，那么在本地注册成功之后，即结束流程。</p>
<p>这样设计的考量是：如果允许 replication 信息反复传递，那么只要任意注册一个应用，稍过一段时间，所有 Eureka 节点的网卡都会被打爆。</p>
<p>因此，在跨集群复制中，不要使用将多节点放置在同一域名，再通过域名传递注册信息实现最终一致的方式实现复制，而必须配置中声明每一个需要同步的节点。</p>
<img src="/img/2020-04/eureka-chain-replica.jpg" width="300px">
<p>在上图中，app 信息更新到 ecs-zone 的 eureka-1 中，随之会被复制到 ecs-zone 的 eureka-2 和 k8s-zone 的 eureka-1，但不会被复制到 k8s-zone 的 eureka-2，最终会导致 k8s-zone 中的某个 Eureka 实例缺少大量注册应用。</p>
<p>同理，其他操作，如续租 (renew), 下线 (cancel) 都是类似的。值得一提的是，Eureka 的设计思想是 AP，所以过期服务淘汰(evict) 并不会同步至其他节点。</p>
<h2 id="eureka-cluster-in-k8s">Eureka cluster in k8s</h2>
<p>任意 Eureka 节点均需知道其他节点的地址，切需要通过固定地址维续通信，于是 Eureka 集群在 k8s 中的适宜部署为 StatefuleSet。在 StatefulSet yaml 中，只需要将节点信息替换称固定域名即可，这里省去该部分配置。</p>
<p>值得注意的是，这里使用了多个 Service 暴露底层的 Eureka 实例，原因都写在注释中，StatefulSet 需要根据 Service 声明生成节点域名，如果 StatefulSet 名为 eureka，那么节点固定域名就是 eureka-0.eureka-svc, eureka-1.eureka-svc,&hellip;, eureka-n.eureka-svc。</p>
<p>上文提到，Eureka 节点之间的信息同步不能统一域名负载，因此不能简单在 eureka-svc 上层放一个 Ingress 暴露给 ECS Eureka 注册，而是需要通过单独的 Service 逐个挑选 Eureka 实例（结合 StatefulSet label)，再通过 NodePort 或者 Ingress 逐个暴露。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml">---<span class="w">
</span><span class="w"></span><span class="c"># headless Service, 绑定到 StatefulSet 使用</span><span class="w">
</span><span class="w"></span>apiVersion<span class="p">:</span><span class="w"> </span>v1<span class="w">
</span><span class="w"></span>kind<span class="p">:</span><span class="w"> </span>Service<span class="w">
</span><span class="w"></span>metadata<span class="p">:</span><span class="w">
</span><span class="w">  </span>name<span class="p">:</span><span class="w"> </span>eureka-svc<span class="w">
</span><span class="w"></span>spec<span class="p">:</span><span class="w">
</span><span class="w">  </span>clusterIP<span class="p">:</span><span class="w"> </span>None<span class="w">
</span><span class="w">  </span>ports<span class="p">:</span><span class="w">
</span><span class="w">    </span>-<span class="w"> </span>port<span class="p">:</span><span class="w"> </span><span class="m">8761</span><span class="w">
</span><span class="w">      </span>targetPort<span class="p">:</span><span class="w"> </span><span class="m">8761</span><span class="w">
</span><span class="w">  </span>selector<span class="p">:</span><span class="w">
</span><span class="w">    </span>app<span class="p">:</span><span class="w"> </span>eureka<span class="w">
</span><span class="w"></span>---<span class="w">
</span><span class="w"></span><span class="c"># 与 Pod 一一对应，供 ECS eureka 注册</span><span class="w">
</span><span class="w"></span>apiVersion<span class="p">:</span><span class="w"> </span>v1<span class="w">
</span><span class="w"></span>kind<span class="p">:</span><span class="w"> </span>Service<span class="w">
</span><span class="w"></span>metadata<span class="p">:</span><span class="w">
</span><span class="w">  </span>name<span class="p">:</span><span class="w"> </span>eureka<span class="m">-0</span>-svc<span class="w">
</span><span class="w"></span>spec<span class="p">:</span><span class="w">
</span><span class="w">  </span>type<span class="p">:</span><span class="w"> </span>NodePort<span class="w">
</span><span class="w">  </span>ports<span class="p">:</span><span class="w">
</span><span class="w">    </span>-<span class="w"> </span>nodePort<span class="p">:</span><span class="w"> </span><span class="m">30761</span><span class="w">
</span><span class="w">      </span>port<span class="p">:</span><span class="w"> </span><span class="m">8761</span><span class="w">
</span><span class="w">      </span>targetPort<span class="p">:</span><span class="w"> </span><span class="m">8761</span><span class="w">
</span><span class="w">      </span>protocol<span class="p">:</span><span class="w"> </span>TCP<span class="w">
</span><span class="w">  </span>selector<span class="p">:</span><span class="w">
</span><span class="w">    </span>app<span class="p">:</span><span class="w"> </span>eureka<span class="w">
</span><span class="w">    </span><span class="s2">&#34;statefulset.kubernetes.io/pod-name&#34;</span><span class="p">:</span><span class="w"> </span>eureka<span class="m">-0</span><span class="w">
</span><span class="w"></span>---<span class="w">
</span><span class="w"></span><span class="c"># 与 Pod 一一对应，供 ECS eureka 注册</span><span class="w">
</span><span class="w"></span>apiVersion<span class="p">:</span><span class="w"> </span>v1<span class="w">
</span><span class="w"></span>kind<span class="p">:</span><span class="w"> </span>Service<span class="w">
</span><span class="w"></span>metadata<span class="p">:</span><span class="w">
</span><span class="w">  </span>name<span class="p">:</span><span class="w"> </span>eureka<span class="m">-1</span>-svc<span class="w">
</span><span class="w"></span>spec<span class="p">:</span><span class="w">
</span><span class="w">  </span>type<span class="p">:</span><span class="w"> </span>NodePort<span class="w">
</span><span class="w">  </span>ports<span class="p">:</span><span class="w">
</span><span class="w">    </span>-<span class="w"> </span>nodePort<span class="p">:</span><span class="w"> </span><span class="m">30762</span><span class="w">
</span><span class="w">      </span>port<span class="p">:</span><span class="w"> </span><span class="m">8761</span><span class="w">
</span><span class="w">      </span>targetPort<span class="p">:</span><span class="w"> </span><span class="m">8761</span><span class="w">
</span><span class="w">      </span>protocol<span class="p">:</span><span class="w"> </span>TCP<span class="w">
</span><span class="w">  </span>selector<span class="p">:</span><span class="w">
</span><span class="w">    </span>app<span class="p">:</span><span class="w"> </span>eureka<span class="w">
</span><span class="w">    </span><span class="s2">&#34;statefulset.kubernetes.io/pod-name&#34;</span><span class="p">:</span><span class="w"> </span>eureka<span class="m">-1</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><p>看到这里，你应该已经明白如何实现 k8s Eureka 与外部 Eureka 信息同步了。</p>
<h2 id="-eureka-1">为什么关闭 Eureka 自我保护</h2>
<p>Eureka 自我保护 (eureka-self-preservation-renewal) 功能，旨在出现 network partition 时，禁用 evict 机制，不再淘汰服务实例，这里有很好的<a href="https://www.baeldung.com/eureka-self-preservation-renewal">介绍文章</a>。</p>
<p>默认情况下，如果 Eureka 没收到超过 85% 实例的续租信息，自我保护就会开启。</p>
<p>迁移早期，k8s Eureka 集群中的大部分实例均来自 ECS 集群。但凡发生点网络抖动，或者 ECS Eureka 重启，就会触发 k8s Eureka 自我保护。结果就是 k8s Eureka 存在大量过期实例，一致性特差，服务调用失败频发。因此笔者在实践中关闭了自我保护。</p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">Zeng Xu</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
        2020-05-07 01:00
        
    </span>
  </p>
  
  <p class="copyright-item">
    <span class="item-title">License</span>
    <span class="item-content">本作品采用 <a rel="license noopener" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a> 进行许可，转载时请注明原文链接。</span>
  </p>
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/spring-cloud/">Spring Cloud</a>
          <a href="/tags/eureka/">Eureka</a>
          <a href="/tags/k8s/">k8s</a>
          <a href="/tags/spring/">Spring</a>
          <a href="/tags/java/">Java</a>
          </div>
      <nav class="post-nav">
        
        <a class="next" href="/post/20200425-eureka-schedule-tasks/">
            <span class="next-text nav-default">从定时任务理解 Eureka 架构设计</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        <div id="gitalk-container"></div>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js" crossorigin="anonymous"></script>
    <script type="text/javascript">
      var gitalk = new Gitalk({
        id: '2020-04-28 20:32:51 \x2b0800 CST',
        title: '如何迁移 Spring Cloud Eureka 注册体系至 k8s',
        clientID: '6ab3c721bb197ea92f1e',
        clientSecret: '217d38cc1905f60f1d963c555be606ed3e707937',
        repo: 'phosae.github.io',
        owner: 'phosae',
        admin: ['phosae'],
        body: decodeURI(location.href)
      });
      gitalk.render('gitalk-container');
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://github.com/gitalk/gitalk">comments powered by gitalk.</a></noscript>

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:zenngxu@gmail.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/phosae" class="iconfont icon-github" title="github"></a>
  <a href="https://www.zeng.dev/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2019 - 
    2020
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Zeng Xu</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
<script type="text/javascript" src="/dist/even.26188efa.min.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-149382924-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







</body>
</html>
